<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price History</title>

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="/-/favicon-files/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="/-/favicon-files/favicon.svg">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/-/favicon-files/apple-touch-icon.png">
    <link rel="manifest" href="/-/favicon-files/site.webmanifest">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            min-height: 100dvh;
            background: #000;
            color: #fff;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 360px;
            padding: 0 1rem;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 24px;
            text-align: center;
        }
        .converter {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            width: 100%;
            padding-bottom: 50px;
        }
        .date-container {
            display: flex;
            gap: 5px;
            width: 100%;
        }
        .date-container select {
            flex: 1;
            text-align: center;
            text-align-last: center;
        }
        .date-container select option {
            text-align: left;
        }
        .input-container {
            position: relative;
            width: 100%;
        }
        select, input, button {
            width: 100%;
            background: #000;
            color: #fff;
            border: 1px solid #666;
            border-radius: 10px;
            font-size: 20px;
            padding: 14px 12px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-container input {
            padding-left: 28px;
        }
        select:hover, select:focus,
        input:hover, input:focus,
        button:hover, button:focus {
            border-color: #999;
            outline: none;
        }
        input::-webkit-inner-spin-button,
        input::-webkit-outer-spin-button {
            -webkit-appearance: none;
        }
        .usd-container::before {
            content: '$';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #fff;
            font-size: 20px;
            pointer-events: none;
            z-index: 1;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background-color: #111;
        }
        .result-wrapper {
            width: 100%;
            min-height: 60px;
            text-align: center;
        }
        #result {
            margin-top: 20px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        .back-link {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: bold;
            color: #222;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            transition: color .2s;
        }
        .back-link:hover {
            color: #333;
        }
        select option:disabled {
            display: none;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1>Price History</h1>
        <div class="converter">
            <div class="date-container">
                <select id="day" required>
                    <option value="" disabled selected>Day</option>
                </select>
                <select id="month" required>
                    <option value="" disabled selected>Month</option>
                    <option value="01">Jan</option>
                    <option value="02">Feb</option>
                    <option value="03">Mar</option>
                    <option value="04">Apr</option>
                    <option value="05">May</option>
                    <option value="06">Jun</option>
                    <option value="07">Jul</option>
                    <option value="08">Aug</option>
                    <option value="09">Sep</option>
                    <option value="10">Oct</option>
                    <option value="11">Nov</option>
                    <option value="12">Dec</option>
                </select>
                <select id="year" required>
                    <option value="" disabled selected>Year</option>
                </select>
            </div>
            <div class="input-container usd-container">
                <input type="tel" inputmode="decimal" id="usdAmount" placeholder="USD">
            </div>
            <button onclick="getPrice()">What's it worth now?</button>
            <div class="result-wrapper">
                <div id="result"></div>
            </div>
        </div>
    </div>
    <a href="https://pricetools.space" class="back-link">Back</a>
    <script>
        let priceMap = null;
        let currentRate = 0.000016;
        let latestCsvPrice = null;
        const proxyUrl = 'https://api.codetabs.com/v1/proxy/?quest=';
        async function loadCSV() {
            if (priceMap) return;
            try {
                const res = await fetch('/-/data/bitcoin-data.csv');
                const text = await res.text();
                const lines = text.split('\n').filter(l => l.trim());
                priceMap = {};
                let latest = 0;
                lines.forEach((l, i) => {
                    const [rawDate, priceStr] = l.split(',');
                    if (rawDate && priceStr) {
                        const [m, d, y] = rawDate.trim().split('/');
                        const year = y.length === 2 ? '20' + y : y;
                        const month = m.padStart(2, '0');
                        const day = d.padStart(2, '0');
                        const key = `${year}-${month}-${day}`;
                        const price = parseFloat(priceStr.trim());
                        if (!isNaN(price)) {
                            priceMap[key] = price;
                            if (price > latest) latest = price;
                            if (i === 0) latestCsvPrice = price;
                        }
                    }
                });
                currentRate = latest > 0 ? 1 / latest : currentRate;
            } catch (e) {
                console.error(e);
            }
        }
        async function fetchCurrentPrice() {
            const url = 'https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT';
            const apiUrl = proxyUrl + encodeURIComponent(url);
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error();
                const data = await res.json();
                const usdPrice = parseFloat(data.price);
                currentRate = usdPrice > 0 ? 1 / usdPrice : currentRate;
                return currentRate;
            } catch (e) {
                if (latestCsvPrice) {
                    currentRate = 1 / latestCsvPrice;
                }
                return currentRate;
            }
        }
        async function getHistoricalPrice(year, month, day) {
            const key = `${year}-${month}-${day}`;
            if (priceMap && priceMap[key]) return 1 / priceMap[key];
            const dateStr = `${year}-${month}-${day}T12:00:00Z`;
            const ts = new Date(dateStr).getTime();
            const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&startTime=${ts}&endTime=${ts + 86400000}&limit=1`;
            const apiUrl = proxyUrl + encodeURIComponent(url);
            try {
                const res = await fetch(apiUrl);
                if (!res.ok) throw new Error();
                const data = await res.json();
                if (data && data[0]) {
                    const close = parseFloat(data[0][4]);
                    return close > 0 ? 1 / close : currentRate;
                }
                return currentRate;
            } catch (e) {
                return currentRate;
            }
        }
        function populateDateSelectors() {
            const day = document.getElementById('day');
            const year = document.getElementById('year');
            day.innerHTML = '<option value="" disabled selected>Day</option>';
            year.innerHTML = '<option value="" disabled selected>Year</option>';
            for (let i = 1; i <= 31; i++) {
                const o = document.createElement('option');
                o.value = i.toString().padStart(2, '0');
                o.text = o.value;
                day.appendChild(o);
            }
            for (let i = 2011; i <= new Date().getFullYear(); i++) {
                const o = document.createElement('option');
                o.value = i;
                o.text = i;
                year.appendChild(o);
            }
            [day, document.getElementById('month'), year].forEach(s => {
                s.addEventListener('click', () => setTimeout(() => { if (document.activeElement !== s) s.focus(); }, 50));
            });
            const usd = document.getElementById('usdAmount');
            usd.addEventListener('click', () => setTimeout(() => { if (document.activeElement !== usd) usd.focus(); }, 50));
        }
        document.getElementById('usdAmount').addEventListener('input', function() {
            let v = this.value.replace(/[^0-9.]/g, '');
            if (v.split('.').length > 2) v = v.replace(/\.(?=.*\.)/g, '');
            if (v.includes('.')) {
                const [i, d] = v.split('.');
                if (d && d.length > 2) v = i + '.' + d.slice(0, 2);
            }
            const [ip] = v.split('.');
            const c = ip.replace(/,/g, '');
            if (c) {
                const f = Number(c).toLocaleString('en-US');
                v = v.includes('.') ? `${f}.${v.split('.')[1]}` : f;
            }
            this.value = v;
        });
        const formatNumber = n => new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2, useGrouping: true }).format(n);
        const formatNumberWithSuffix = n => {
            if (isNaN(n)) return "0";
            const suffixes = [
                { threshold: 1e108, suffix: "quintrigintillion" },
                { threshold: 1e105, suffix: "quattuortrigintillion" },
                { threshold: 1e102, suffix: "tretrigintillion" },
                { threshold: 1e99, suffix: "duotrigintillion" },
                { threshold: 1e96, suffix: "untrigintillion" },
                { threshold: 1e93, suffix: "trigintillion" },
                { threshold: 1e90, suffix: "novemvigintillion" },
                { threshold: 1e87, suffix: "octovigintillion" },
                { threshold: 1e84, suffix: "septenvigintillion" },
                { threshold: 1e81, suffix: "sexvigintillion" },
                { threshold: 1e78, suffix: "quinvigintillion" },
                { threshold: 1e75, suffix: "quattuorvigintillion" },
                { threshold: 1e72, suffix: "trevigintillion" },
                { threshold: 1e69, suffix: "duovigintillion" },
                { threshold: 1e66, suffix: "unvigintillion" },
                { threshold: 1e63, suffix: "vigintillion" },
                { threshold: 1e60, suffix: "novemdecillion" },
                { threshold: 1e57, suffix: "octodecillion" },
                { threshold: 1e54, suffix: "septendecillion" },
                { threshold: 1e51, suffix: "sexdecillion" },
                { threshold: 1e48, suffix: "quindecillion" },
                { threshold: 1e45, suffix: "quattuordecillion" },
                { threshold: 1e42, suffix: "tredecillion" },
                { threshold: 1e39, suffix: "duodecillion" },
                { threshold: 1e36, suffix: "undecillion" },
                { threshold: 1e33, suffix: "decillion" },
                { threshold: 1e30, suffix: "nonillion" },
                { threshold: 1e27, suffix: "octillion" },
                { threshold: 1e24, suffix: "septillion" },
                { threshold: 1e21, suffix: "sextillion" },
                { threshold: 1e18, suffix: "quintillion" },
                { threshold: 1e15, suffix: "quadrillion" },
                { threshold: 1e12, suffix: "trillion" },
                { threshold: 1e9, suffix: "billion" },
                { threshold: 1e6, suffix: "million" }
            ];
            for (const { threshold, suffix } of suffixes) {
                if (n >= threshold) {
                    return new Intl.NumberFormat('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 1 }).format(n / threshold) + " " + suffix;
                }
            }
            return formatNumber(n);
        };
        const formatDate = (m, d, y) => {
            const months = { '01': 'January', '02': 'February', '03': 'March', '04': 'April', '05': 'May', '06': 'June', '07': 'July', '08': 'August', '09': 'September', '10': 'October', '11': 'November', '12': 'December' };
            const dn = parseInt(d);
            const suf = dn === 1 || dn === 21 || dn === 31 ? 'st' : dn === 2 || dn === 22 ? 'nd' : dn === 3 || dn === 23 ? 'rd' : 'th';
            return `${months[m]} ${dn}${suf}, ${y}`;
        };
        function animateNumber(start, end, elem, usd, dateStr, dur = 1000) {
            const step = 50;
            const steps = dur / step;
            const inc = (end - start) / steps;
            let cur = start;
            elem.innerText = `$${formatNumberWithSuffix(usd)} of Bitcoin on ${dateStr} is worth $${formatNumberWithSuffix(cur.toFixed(2))} today.`;
            const i = setInterval(() => {
                cur += inc;
                if ((inc > 0 && cur >= end) || (inc < 0 && cur <= end)) { cur = end; clearInterval(i); }
                elem.innerText = `$${formatNumberWithSuffix(usd)} of Bitcoin on ${dateStr} is worth $${formatNumberWithSuffix(cur.toFixed(2))} today.`;
            }, step);
        }
        function debounce(fn, w) {
            let t;
            return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), w); };
        }
        const getPrice = debounce(async () => {
            const y = document.getElementById('year').value;
            const m = document.getElementById('month').value;
            const d = document.getElementById('day').value;
            const raw = document.getElementById('usdAmount').value.trim();
            const res = document.getElementById('result');
            const usd = parseFloat(raw.replace(/,/g, ''));
            if (!y || !m || !d || isNaN(usd) || usd <= 0) { res.innerText = 'Invalid input.'; return; }
            const date = new Date(`${y}-${m}-${d}T00:00:00`);
            const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            if (isNaN(date)) { res.innerText = 'Invalid date.'; return; }
            if (date > yesterday) { res.innerText = 'Date must be on or before yesterday.'; return; }
            const fmt = formatDate(m, d, y);
            await loadCSV();
            const [hist, cur] = await Promise.all([getHistoricalPrice(y, m, d), fetchCurrentPrice()]);
            const btc = usd * hist;
            const now = btc / cur;
            animateNumber(usd, now, res, usd, fmt);
        }, 150);
        populateDateSelectors();
        loadCSV();
        fetchCurrentPrice();
        setInterval(fetchCurrentPrice, 30000);
    </script>
</body>
</html>